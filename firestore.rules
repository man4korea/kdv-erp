// ğŸ“ firestore.rules
// KDV ERP ì‹œìŠ¤í…œ - Firestore ë³´ì•ˆ ê·œì¹™
// Create at 250524_2000 Ver1.00

rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // ========================================================================
    // 1. ì‚¬ìš©ì(users) ì»¬ë ‰ì…˜ - ì‚¬ìš©ì ê¸°ë³¸ ì •ë³´ ë° ê¶Œí•œ ê´€ë¦¬
    // ========================================================================
    match /users/{userId} {
      // ì½ê¸° ê¶Œí•œ: ì¸ì¦ëœ ì‚¬ìš©ìë§Œ ìì‹ ì˜ ì •ë³´ì™€ ë‹¤ë¥¸ ì‚¬ìš©ìì˜ ê¸°ë³¸ ì •ë³´ë§Œ ì¡°íšŒ ê°€ëŠ¥
      allow read: if request.auth != null && 
        (request.auth.uid == userId || 
         resource.data.securityLevel in ['ì¼ë°˜', 'ê´€ë¦¬ì']);
      
      // ì“°ê¸° ê¶Œí•œ: ê´€ë¦¬ì ì´ìƒë§Œ ì‚¬ìš©ì ì •ë³´ ìƒì„±/ìˆ˜ì • ê°€ëŠ¥
      allow write: if request.auth != null && 
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.securityLevel in ['ê´€ë¦¬ì', 'ìµœê³ ê´€ë¦¬ì'];
      
      // ì‚­ì œ ê¶Œí•œ: ìµœê³ ê´€ë¦¬ìë§Œ ê°€ëŠ¥
      allow delete: if request.auth != null && 
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.securityLevel == 'ìµœê³ ê´€ë¦¬ì';
    }
    
    // ========================================================================
    // 2. ì§ì›(employees) ì»¬ë ‰ì…˜ - ì§ì› ì •ë³´ ê´€ë¦¬
    // ========================================================================
    match /employees/{employeeId} {
      // ì½ê¸° ê¶Œí•œ: ì¸ì¦ëœ ëª¨ë“  ì‚¬ìš©ìê°€ ì§ì› ì •ë³´ ì¡°íšŒ ê°€ëŠ¥ (ë¯¼ê°ì •ë³´ ì œì™¸)
      allow read: if request.auth != null;
      
      // ìƒì„± ê¶Œí•œ: ê´€ë¦¬ì ì´ìƒë§Œ ìƒˆ ì§ì› ë“±ë¡ ê°€ëŠ¥
      allow create: if request.auth != null && 
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.securityLevel in ['ê´€ë¦¬ì', 'ìµœê³ ê´€ë¦¬ì'] &&
        validateEmployeeData(request.resource.data);
      
      // ìˆ˜ì • ê¶Œí•œ: ê´€ë¦¬ì ì´ìƒë§Œ ì§ì› ì •ë³´ ìˆ˜ì • ê°€ëŠ¥
      allow update: if request.auth != null && 
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.securityLevel in ['ê´€ë¦¬ì', 'ìµœê³ ê´€ë¦¬ì'] &&
        validateEmployeeData(request.resource.data);
      
      // ì‚­ì œ ê¶Œí•œ: ìµœê³ ê´€ë¦¬ìë§Œ ê°€ëŠ¥
      allow delete: if request.auth != null && 
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.securityLevel == 'ìµœê³ ê´€ë¦¬ì';
    }
    
    // ========================================================================
    // 3. ì§ì› ê°œì¸ì •ë³´(employee_private) ì»¬ë ‰ì…˜ - ë¯¼ê°í•œ ê°œì¸ì •ë³´ ë¶„ë¦¬ ì €ì¥
    // ========================================================================
    match /employee_private/{employeeId} {
      // ì½ê¸°/ì“°ê¸° ê¶Œí•œ: ìµœê³ ê´€ë¦¬ìë§Œ ì ‘ê·¼ ê°€ëŠ¥
      allow read, write: if request.auth != null && 
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.securityLevel == 'ìµœê³ ê´€ë¦¬ì';
    }
    
    // ========================================================================
    // 4. ì‹œìŠ¤í…œ ë¡œê·¸(system_logs) ì»¬ë ‰ì…˜ - ì‹œìŠ¤í…œ í™œë™ ë¡œê·¸
    // ========================================================================
    match /system_logs/{logId} {
      // ì½ê¸° ê¶Œí•œ: ê´€ë¦¬ì ì´ìƒë§Œ ê°€ëŠ¥
      allow read: if request.auth != null && 
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.securityLevel in ['ê´€ë¦¬ì', 'ìµœê³ ê´€ë¦¬ì'];
      
      // ìƒì„± ê¶Œí•œ: ëª¨ë“  ì¸ì¦ëœ ì‚¬ìš©ìê°€ ë¡œê·¸ ìƒì„± ê°€ëŠ¥ (ì‹œìŠ¤í…œì—ì„œ ìë™ ìƒì„±)
      allow create: if request.auth != null;
      
      // ìˆ˜ì •/ì‚­ì œ ê¸ˆì§€: ë¡œê·¸ëŠ” ë³€ê²½ ë¶ˆê°€
      allow update, delete: if false;
    }
    
    // ========================================================================
    // 5. ë¶€ì„œ(departments) ì»¬ë ‰ì…˜ - ì¡°ì§ë„ ê´€ë¦¬
    // ========================================================================
    match /departments/{departmentId} {
      // ì½ê¸° ê¶Œí•œ: ëª¨ë“  ì¸ì¦ëœ ì‚¬ìš©ì
      allow read: if request.auth != null;
      
      // ì“°ê¸° ê¶Œí•œ: ê´€ë¦¬ì ì´ìƒë§Œ ê°€ëŠ¥
      allow write: if request.auth != null && 
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.securityLevel in ['ê´€ë¦¬ì', 'ìµœê³ ê´€ë¦¬ì'];
    }
    
    // ========================================================================
    // í—¬í¼ í•¨ìˆ˜ë“¤
    // ========================================================================
    
    // ì§ì› ë°ì´í„° ìœ íš¨ì„± ê²€ì¦ í•¨ìˆ˜
    function validateEmployeeData(data) {
      return data.keys().hasAll(['name', 'department', 'position', 'status']) &&
             data.name is string && data.name.size() > 0 &&
             data.department is string && data.department.size() > 0 &&
             data.position is string && data.position.size() > 0 &&
             data.status in ['ì¬ì§', 'íœ´ì§', 'í‡´ì§'] &&
             (data.mobile == null || (data.mobile is string && data.mobile.matches('^010-[0-9]{4}-[0-9]{4}$'))) &&
             (data.email == null || (data.email is string && data.email.matches('^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\\.[a-zA-Z]{2,}$')));
    }
    
    // ì‚¬ìš©ì ê¶Œí•œ í™•ì¸ í•¨ìˆ˜
    function isAuthorized(level) {
      return request.auth != null && 
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.securityLevel == level;
    }
    
    // ê´€ë¦¬ì ì´ìƒ ê¶Œí•œ í™•ì¸ í•¨ìˆ˜
    function isManagerOrHigher() {
      return request.auth != null && 
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.securityLevel in ['ê´€ë¦¬ì', 'ìµœê³ ê´€ë¦¬ì'];
    }
    
    // ========================================================================
    // ê¸°ë³¸ ê±°ë¶€ ê·œì¹™ - ëª…ì‹œì ìœ¼ë¡œ í—ˆìš©ë˜ì§€ ì•Šì€ ëª¨ë“  ìš”ì²­ ì°¨ë‹¨
    // ========================================================================
    match /{document=**} {
      allow read, write: if false;
    }
  }
}

/*
==========================================================================
ë³´ì•ˆ ë ˆë²¨ ë° ê¶Œí•œ ì²´ê³„
==========================================================================

1. ì¼ë°˜ ì‚¬ìš©ì (ì¼ë°˜):
   - ì§ì› ì •ë³´ ì¡°íšŒ (ë¯¼ê°ì •ë³´ ì œì™¸)
   - ìì‹ ì˜ ì‚¬ìš©ì ì •ë³´ ì¡°íšŒ
   - ë¶€ì„œ ì •ë³´ ì¡°íšŒ

2. ê´€ë¦¬ì (ê´€ë¦¬ì):
   - ì¼ë°˜ ì‚¬ìš©ì ê¶Œí•œ + 
   - ì§ì› ì •ë³´ ìƒì„±/ìˆ˜ì •
   - ì‚¬ìš©ì ì •ë³´ ìƒì„±/ìˆ˜ì •
   - ë¶€ì„œ ì •ë³´ ê´€ë¦¬
   - ì‹œìŠ¤í…œ ë¡œê·¸ ì¡°íšŒ

3. ìµœê³ ê´€ë¦¬ì (ìµœê³ ê´€ë¦¬ì):
   - ê´€ë¦¬ì ê¶Œí•œ +
   - ì§ì›/ì‚¬ìš©ì ì‚­ì œ
   - ë¯¼ê°í•œ ê°œì¸ì •ë³´ ì ‘ê·¼
   - ëª¨ë“  ì‹œìŠ¤í…œ ê¶Œí•œ

==========================================================================
ì»¬ë ‰ì…˜ë³„ ë°ì´í„° êµ¬ì¡°
==========================================================================

1. users ì»¬ë ‰ì…˜:
   - uid: string (Firebase Auth UID)
   - email: string
   - displayName: string
   - securityLevel: string ('ì¼ë°˜', 'ê´€ë¦¬ì', 'ìµœê³ ê´€ë¦¬ì')
   - isActive: boolean
   - createdAt: timestamp
   - updatedAt: timestamp

2. employees ì»¬ë ‰ì…˜:
   - name: string
   - department: string
   - position: string
   - status: string ('ì¬ì§', 'íœ´ì§', 'í‡´ì§')
   - mobile: string (optional)
   - email: string (optional)
   - joinDate: timestamp (optional)
   - createdAt: timestamp
   - updatedAt: timestamp
   - createdBy: string (user uid)

3. employee_private ì»¬ë ‰ì…˜:
   - employeeId: string (employees ì»¬ë ‰ì…˜ ì°¸ì¡°)
   - personalId: string (ì•”í˜¸í™”ëœ ì£¼ë¯¼ë“±ë¡ë²ˆí˜¸)
   - address: string
   - emergencyContact: object
   - bankAccount: object (ì•”í˜¸í™”)
   - salary: object (ì•”í˜¸í™”)
   - createdAt: timestamp
   - updatedAt: timestamp

4. system_logs ì»¬ë ‰ì…˜:
   - action: string
   - userId: string
   - targetCollection: string
   - targetDocumentId: string
   - details: object
   - timestamp: timestamp
   - ipAddress: string

5. departments ì»¬ë ‰ì…˜:
   - name: string
   - code: string
   - parentDepartment: string (optional)
   - manager: string (employee reference)
   - isActive: boolean
   - createdAt: timestamp
   - updatedAt: timestamp

==========================================================================
*/