<!DOCTYPE html>
<html lang="ko">
<!-- ğŸ“ admin/create-users.html
     Firebase ì‚¬ìš©ì ê³„ì • ìƒì„± ë„êµ¬
     Create at 250524_2150 Ver1.00 -->
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì‚¬ìš©ì ê³„ì • ìƒì„± - KDV ERP ê´€ë¦¬</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f8f9fa;
        }
        .container {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .result {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            border-left: 4px solid #007bff;
            font-family: monospace;
            white-space: pre-wrap;
            font-size: 14px;
        }
        .error { border-left-color: #dc3545; background: #f8d7da; }
        .success { border-left-color: #28a745; background: #d4edda; }
        .warning { border-left-color: #ffc107; background: #fff3cd; }
        
        .form-group {
            margin: 20px 0;
        }
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
        }
        input, select {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 16px;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            margin: 10px 5px;
            font-size: 16px;
        }
        button:hover { background: #0056b3; }
        button.danger { background: #dc3545; }
        button.danger:hover { background: #c82333; }
        button.success { background: #28a745; }
        button.success:hover { background: #218838; }
        
        .preset-users {
            background: #e3f2fd;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
        }
        .preset-user {
            background: white;
            padding: 15px;
            border-radius: 6px;
            margin: 10px 0;
            border: 1px solid #bbdefb;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”¥ KDV ERP ì‚¬ìš©ì ê³„ì • ìƒì„±</h1>
        <p>Firebase Authenticationì— ì‚¬ìš©ì ê³„ì •ì„ ìƒì„±í•©ë‹ˆë‹¤.</p>
        
        <div class="preset-users">
            <h3>ğŸ“‹ ê¸°ë³¸ ì‚¬ìš©ì ê³„ì • ìƒì„±</h3>
            <p>ì‹œìŠ¤í…œì— í•„ìš”í•œ ê¸°ë³¸ ê³„ì •ë“¤ì„ ìë™ìœ¼ë¡œ ìƒì„±í•©ë‹ˆë‹¤.</p>
            
            <div class="preset-user">
                <strong>ğŸ‘‘ ê´€ë¦¬ì ê³„ì •</strong><br>
                ì´ë©”ì¼: man4korea@gmail.com<br>
                ë¹„ë°€ë²ˆí˜¸: dmlwjdqn@Wkd24<br>
                ê¶Œí•œ: 1ê¸‰ ê´€ë¦¬ì
            </div>
            
            <div class="preset-user">
                <strong>ğŸ‘¤ í…ŒìŠ¤íŠ¸ ì‚¬ìš©ì</strong><br>
                ì´ë©”ì¼: test@kdv.co.kr<br>
                ë¹„ë°€ë²ˆí˜¸: test123456<br>
                ê¶Œí•œ: ì¼ë°˜ ì‚¬ìš©ì
            </div>
            
            <button onclick="createPresetUsers()" class="success">ğŸš€ ê¸°ë³¸ ê³„ì • ìƒì„±</button>
        </div>
        
        <hr style="margin: 40px 0;">
        
        <h3>â• ê°œë³„ ê³„ì • ìƒì„±</h3>
        <form id="userForm">
            <div class="form-group">
                <label for="email">ğŸ“§ ì´ë©”ì¼ ì£¼ì†Œ</label>
                <input type="email" id="email" required placeholder="user@company.com">
            </div>
            
            <div class="form-group">
                <label for="password">ğŸ”’ ë¹„ë°€ë²ˆí˜¸</label>
                <input type="password" id="password" required placeholder="ìµœì†Œ 6ì ì´ìƒ" minlength="6">
            </div>
            
            <div class="form-group">
                <label for="securityLevel">ğŸ” ë³´ì•ˆ ë“±ê¸‰</label>
                <select id="securityLevel">
                    <option value="ì¼ë°˜">ì¼ë°˜ ì‚¬ìš©ì</option>
                    <option value="2ê¸‰">2ê¸‰ ë³´ì•ˆ</option>
                    <option value="1ê¸‰">1ê¸‰ ê´€ë¦¬ì</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="isAdmin">ğŸ‘‘ ê´€ë¦¬ì ê¶Œí•œ</label>
                <select id="isAdmin">
                    <option value="false">ì¼ë°˜ ì‚¬ìš©ì</option>
                    <option value="true">ê´€ë¦¬ì</option>
                </select>
            </div>
            
            <button type="submit">â• ê³„ì • ìƒì„±</button>
        </form>
        
        <hr style="margin: 40px 0;">
        
        <h3>ğŸ” ê³„ì • ê´€ë¦¬</h3>
        <button onclick="listUsers()">ğŸ‘¥ ì „ì²´ ì‚¬ìš©ì ì¡°íšŒ</button>
        <button onclick="testLogin()">ğŸ§ª ë¡œê·¸ì¸ í…ŒìŠ¤íŠ¸</button>
        <button onclick="clearResults()">ğŸ§¹ ê²°ê³¼ ì§€ìš°ê¸°</button>
        
        <div id="results"></div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-app.js";
        import { 
            getAuth,
            createUserWithEmailAndPassword,
            signInWithEmailAndPassword,
            signOut,
            updateProfile
        } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            setDoc,
            serverTimestamp,
            collection,
            getDocs
        } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-firestore.js";
        
        const firebaseConfig = {
            apiKey: "AIzaSyAfSlSi4pNlKvMU-NBpQ3ZWSeG4QNpZiCk",
            authDomain: "kdv-sys.firebaseapp.com",
            projectId: "kdv-sys",
            storageBucket: "kdv-sys.firebasestorage.app",
            messagingSenderId: "352925761129",
            appId: "1:352925761129:web:a9c9cf2e1154d745faecf8"
        };
        
        let app, auth, db;
        
        // Firebase ì´ˆê¸°í™”
        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
            addResult('âœ… Firebase ì´ˆê¸°í™” ì„±ê³µ!', 'success');
        } catch (error) {
            addResult(`âŒ Firebase ì´ˆê¸°í™” ì‹¤íŒ¨: ${error.message}`, 'error');
        }
        
        function addResult(message, type = 'info') {
            const results = document.getElementById('results');
            const div = document.createElement('div');
            div.className = `result ${type}`;
            div.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            results.appendChild(div);
            console.log(message);
            
            // ìŠ¤í¬ë¡¤ì„ ì•„ë˜ë¡œ
            div.scrollIntoView({ behavior: 'smooth' });
        }
        
        // ê°œë³„ ì‚¬ìš©ì ìƒì„±
        async function createUser(email, password, securityLevel, isAdmin) {
            try {
                addResult(`ğŸ”„ ì‚¬ìš©ì ìƒì„± ì¤‘: ${email}`);
                
                // Firebase Authenticationì— ì‚¬ìš©ì ìƒì„±
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;
                
                addResult(`âœ… Authentication ì‚¬ìš©ì ìƒì„± ì„±ê³µ: ${user.uid}`);
                
                // Firestoreì— ì‚¬ìš©ì í”„ë¡œí•„ ì €ì¥
                const userProfile = {
                    email: email,
                    securityLevel: securityLevel,
                    isAdmin: isAdmin === 'true' || isAdmin === true,
                    createdAt: serverTimestamp(),
                    lastLoginAt: null,
                    employeeId: null,
                    displayName: email.split('@')[0]
                };
                
                await setDoc(doc(db, 'users', user.uid), userProfile);
                
                addResult(`âœ… ì‚¬ìš©ì í”„ë¡œí•„ ì €ì¥ ì™„ë£Œ: ${email} [${securityLevel}]`, 'success');
                
                // ë¡œê·¸ì•„ì›ƒ (ìƒì„± í›„ ìë™ ë¡œê·¸ì¸ë˜ë¯€ë¡œ)
                await signOut(auth);
                
                return { success: true, uid: user.uid };
                
            } catch (error) {
                let errorMessage = `âŒ ì‚¬ìš©ì ìƒì„± ì‹¤íŒ¨: ${email}\\n`;
                
                switch (error.code) {
                    case 'auth/email-already-in-use':
                        errorMessage += 'ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ì´ë©”ì¼ ì£¼ì†Œì…ë‹ˆë‹¤.';
                        break;
                    case 'auth/invalid-email':
                        errorMessage += 'ì˜ëª»ëœ ì´ë©”ì¼ í˜•ì‹ì…ë‹ˆë‹¤.';
                        break;
                    case 'auth/weak-password':
                        errorMessage += 'ë¹„ë°€ë²ˆí˜¸ê°€ ë„ˆë¬´ ì•½í•©ë‹ˆë‹¤. (ìµœì†Œ 6ì)';
                        break;
                    default:
                        errorMessage += `ì˜¤ë¥˜ ì½”ë“œ: ${error.code}\\në©”ì‹œì§€: ${error.message}`;
                }
                
                addResult(errorMessage, 'error');
                return { success: false, error: error.code };
            }
        }
        
        // ê¸°ë³¸ ì‚¬ìš©ìë“¤ ìƒì„±
        window.createPresetUsers = async function() {
            addResult('ğŸš€ ê¸°ë³¸ ì‚¬ìš©ì ê³„ì • ìƒì„± ì‹œì‘...', 'warning');
            
            const presetUsers = [
                {
                    email: 'man4korea@gmail.com',
                    password: 'dmlwjdqn@Wkd24',
                    securityLevel: '1ê¸‰',
                    isAdmin: true
                },
                {
                    email: 'test@kdv.co.kr',
                    password: 'test123456',
                    securityLevel: 'ì¼ë°˜',
                    isAdmin: false
                }
            ];
            
            let successCount = 0;
            let failCount = 0;
            
            for (const userData of presetUsers) {
                const result = await createUser(
                    userData.email, 
                    userData.password, 
                    userData.securityLevel, 
                    userData.isAdmin
                );
                
                if (result.success) {
                    successCount++;
                } else {
                    failCount++;
                }
                
                // ì ì‹œ ëŒ€ê¸° (API ì œí•œ ë°©ì§€)
                await new Promise(resolve => setTimeout(resolve, 1000));
            }
            
            addResult(`ğŸ‰ ê¸°ë³¸ ì‚¬ìš©ì ìƒì„± ì™„ë£Œ!\\nì„±ê³µ: ${successCount}ê°œ, ì‹¤íŒ¨: ${failCount}ê°œ`, 'success');
            
            if (successCount > 0) {
                addResult(`ğŸ’¡ ì´ì œ ë¡œê·¸ì¸ í˜ì´ì§€ì—ì„œ ë‹¤ìŒ ê³„ì •ìœ¼ë¡œ ë¡œê·¸ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:\\n- man4korea@gmail.com (ê´€ë¦¬ì)\\n- test@kdv.co.kr (ì¼ë°˜ ì‚¬ìš©ì)`, 'success');
            }
        }
        
        // í¼ ì œì¶œ ì²˜ë¦¬
        document.getElementById('userForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const securityLevel = document.getElementById('securityLevel').value;
            const isAdmin = document.getElementById('isAdmin').value;
            
            await createUser(email, password, securityLevel, isAdmin);
            
            // í¼ ì´ˆê¸°í™”
            this.reset();
        });
        
        // ì „ì²´ ì‚¬ìš©ì ì¡°íšŒ
        window.listUsers = async function() {
            try {
                addResult('ğŸ” ì „ì²´ ì‚¬ìš©ì ì¡°íšŒ ì¤‘...');
                
                const usersRef = collection(db, 'users');
                const snapshot = await getDocs(usersRef);
                
                if (snapshot.empty) {
                    addResult('ğŸ“­ ë“±ë¡ëœ ì‚¬ìš©ìê°€ ì—†ìŠµë‹ˆë‹¤.', 'warning');
                    return;
                }
                
                let userList = `ğŸ‘¥ ë“±ë¡ëœ ì‚¬ìš©ì ëª©ë¡ (ì´ ${snapshot.size}ëª…):\\n\\n`;
                
                snapshot.forEach((doc) => {
                    const userData = doc.data();
                    const adminBadge = userData.isAdmin ? ' ğŸ‘‘' : '';
                    userList += `ğŸ“§ ${userData.email} [${userData.securityLevel}]${adminBadge}\\n`;
                    userList += `   UID: ${doc.id}\\n`;
                    userList += `   ìƒì„±ì¼: ${userData.createdAt?.toDate?.()?.toLocaleString() || 'N/A'}\\n\\n`;
                });
                
                addResult(userList, 'success');
                
            } catch (error) {
                addResult(`âŒ ì‚¬ìš©ì ì¡°íšŒ ì‹¤íŒ¨: ${error.message}`, 'error');
            }
        }
        
        // ë¡œê·¸ì¸ í…ŒìŠ¤íŠ¸
        window.testLogin = async function() {
            try {
                const testEmail = 'man4korea@gmail.com';
                const testPassword = 'dmlwjdqn@Wkd24';
                
                addResult(`ğŸ§ª ë¡œê·¸ì¸ í…ŒìŠ¤íŠ¸ ì‹œì‘: ${testEmail}`);
                
                const userCredential = await signInWithEmailAndPassword(auth, testEmail, testPassword);
                addResult(`âœ… ë¡œê·¸ì¸ ì„±ê³µ! UID: ${userCredential.user.uid}`, 'success');
                
                // ì¦‰ì‹œ ë¡œê·¸ì•„ì›ƒ
                await signOut(auth);
                addResult('âœ… ë¡œê·¸ì•„ì›ƒ ì™„ë£Œ', 'success');
                
            } catch (error) {
                addResult(`âŒ ë¡œê·¸ì¸ í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨: ${error.code} - ${error.message}`, 'error');
            }
        }
        
        // ê²°ê³¼ ì§€ìš°ê¸°
        window.clearResults = function() {
            document.getElementById('results').innerHTML = '';
        }
        
        // ì „ì—­ í•¨ìˆ˜ë¡œ ë“±ë¡
        window.createUser = createUser;
    </script>
</body>
</html>