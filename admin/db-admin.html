<!DOCTYPE html>
<html lang="ko">
<!-- ğŸ“ admin/db-admin.html
     KDV ERP ì‹œìŠ¤í…œ - ë°ì´í„°ë² ì´ìŠ¤ ê´€ë¦¬ì í˜ì´ì§€
     Create at 250524_2000 Ver1.01 - Firebase v9+ modular ë°©ì‹ ì ìš© -->
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë°ì´í„°ë² ì´ìŠ¤ ê´€ë¦¬ - KDV ERP ì‹œìŠ¤í…œ</title>
    <link rel="stylesheet" href="../css/styles.css">
    <!-- Font Awesome ì•„ì´ì½˜ -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* ê´€ë¦¬ì í˜ì´ì§€ ì „ìš© ìŠ¤íƒ€ì¼ */
        .admin-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: var(--spacing-4);
        }
        
        .admin-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: var(--spacing-6);
            border-radius: var(--radius-lg);
            margin-bottom: var(--spacing-6);
            text-align: center;
        }
        
        .admin-warning {
            background: var(--bg-warning);
            color: #92400e;
            padding: var(--spacing-4);
            border-radius: var(--radius-md);
            margin-bottom: var(--spacing-6);
            border-left: 4px solid var(--warning);
        }
        
        .admin-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: var(--spacing-6);
        }
        
        .admin-card {
            background: var(--bg-primary);
            border-radius: var(--radius-lg);
            padding: var(--spacing-6);
            box-shadow: var(--shadow-lg);
            border: 1px solid var(--border-primary);
        }
        
        .admin-card h3 {
            color: var(--primary);
            margin-bottom: var(--spacing-4);
            font-size: var(--text-lg);
            display: flex;
            align-items: center;
            gap: var(--spacing-2);
        }
        
        .status-display {
            background: var(--bg-secondary);
            padding: var(--spacing-3);
            border-radius: var(--radius-md);
            margin: var(--spacing-3) 0;
            font-family: monospace;
            font-size: var(--text-sm);
            white-space: pre-wrap;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .action-buttons {
            display: flex;
            gap: var(--spacing-2);
            flex-wrap: wrap;
        }
        
        .progress-bar {
            width: 100%;
            height: 8px;
            background: var(--bg-secondary);
            border-radius: 4px;
            overflow: hidden;
            margin: var(--spacing-2) 0;
        }
        
        .progress-fill {
            height: 100%;
            background: var(--primary);
            width: 0%;
            transition: width 0.3s ease;
        }
        
        .collection-stat {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--spacing-2) 0;
            border-bottom: 1px solid var(--border-primary);
        }
        
        .collection-stat:last-child {
            border-bottom: none;
        }
        
        .stat-badge {
            background: var(--primary);
            color: white;
            padding: 2px var(--spacing-2);
            border-radius: var(--radius-full);
            font-size: var(--text-xs);
            font-weight: 500;
        }
        
        .danger-zone {
            border: 2px solid var(--danger);
            border-radius: var(--radius-md);
            padding: var(--spacing-4);
            margin-top: var(--spacing-4);
        }
        
        .danger-zone h4 {
            color: var(--danger);
            margin-bottom: var(--spacing-3);
        }
        
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.9);
            display: none;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            z-index: 9999;
        }
        
        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        @media (max-width: 768px) {
            .admin-grid {
                grid-template-columns: 1fr;
            }
            
            .action-buttons {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <!-- ë¡œë”© ì˜¤ë²„ë ˆì´ -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="spinner"></div>
        <div style="margin-top: 20px; font-size: 14px; color: #666;" id="loadingMessage">
            ë°ì´í„°ë² ì´ìŠ¤ ì‘ì—… ì¤‘...
        </div>
    </div>
    
    <div class="admin-container">
        <!-- ê´€ë¦¬ì í—¤ë” -->
        <div class="admin-header">
            <h1><i class="fas fa-database"></i> ë°ì´í„°ë² ì´ìŠ¤ ê´€ë¦¬ ì‹œìŠ¤í…œ</h1>
            <p>KDV ERP ì‹œìŠ¤í…œ - Firestore ë°ì´í„°ë² ì´ìŠ¤ ì´ˆê¸°í™” ë° ê´€ë¦¬</p>
        </div>
        
        <!-- ê²½ê³  ë©”ì‹œì§€ -->
        <div class="admin-warning">
            <strong><i class="fas fa-exclamation-triangle"></i> ì£¼ì˜ì‚¬í•­:</strong>
            ì´ í˜ì´ì§€ëŠ” ê´€ë¦¬ì ì „ìš©ì…ë‹ˆë‹¤. ë°ì´í„°ë² ì´ìŠ¤ ì´ˆê¸°í™”ëŠ” ê¸°ì¡´ ë°ì´í„°ë¥¼ ì‚­ì œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
            ìš´ì˜ í™˜ê²½ì—ì„œëŠ” ë°˜ë“œì‹œ ë°±ì—… í›„ ì‹¤í–‰í•˜ì„¸ìš”.
        </div>
        
        <!-- ê´€ë¦¬ íŒ¨ë„ ê·¸ë¦¬ë“œ -->
        <div class="admin-grid">
            <!-- ë°ì´í„°ë² ì´ìŠ¤ ìƒíƒœ -->
            <div class="admin-card">
                <h3><i class="fas fa-heartbeat"></i> ë°ì´í„°ë² ì´ìŠ¤ ìƒíƒœ</h3>
                <div class="status-display" id="dbStatus">
                    ìƒíƒœ í™•ì¸ ì¤‘...
                </div>
                <div class="action-buttons">
                    <button class="btn btn-primary" onclick="checkDatabaseStatus()">
                        <i class="fas fa-sync"></i> ìƒíƒœ ìƒˆë¡œê³ ì¹¨
                    </button>
                    <button class="btn btn-secondary" onclick="testConnection()">
                        <i class="fas fa-plug"></i> ì—°ê²° í…ŒìŠ¤íŠ¸
                    </button>
                </div>
            </div>
            
            <!-- ë°ì´í„°ë² ì´ìŠ¤ ì´ˆê¸°í™” -->
            <div class="admin-card">
                <h3><i class="fas fa-rocket"></i> ë°ì´í„°ë² ì´ìŠ¤ ì´ˆê¸°í™”</h3>
                <p style="margin-bottom: var(--spacing-4); color: var(--text-secondary);">
                    ê¸°ë³¸ ì»¬ë ‰ì…˜ê³¼ í…ŒìŠ¤íŠ¸ ë°ì´í„°ë¥¼ ìƒì„±í•©ë‹ˆë‹¤.
                </p>
                <div class="progress-bar" id="initProgress" style="display: none;">
                    <div class="progress-fill" id="initProgressFill"></div>
                </div>
                <div class="status-display" id="initStatus" style="display: none;">
                    ì´ˆê¸°í™” ëŒ€ê¸° ì¤‘...
                </div>
                <div class="action-buttons">
                    <button class="btn btn-success" onclick="initializeDatabase()">
                        <i class="fas fa-play"></i> ì´ˆê¸°í™” ì‹œì‘
                    </button>
                    <button class="btn btn-info" onclick="showInitPreview()">
                        <i class="fas fa-eye"></i> ë¯¸ë¦¬ë³´ê¸°
                    </button>
                </div>
            </div>
            
            <!-- ì»¬ë ‰ì…˜ í†µê³„ -->
            <div class="admin-card">
                <h3><i class="fas fa-chart-bar"></i> ì»¬ë ‰ì…˜ í†µê³„</h3>
                <div id="collectionStats">
                    <div class="collection-stat">
                        <span>ì‚¬ìš©ì (users)</span>
                        <span class="stat-badge" id="usersCount">-</span>
                    </div>
                    <div class="collection-stat">
                        <span>ì§ì› (employees)</span>
                        <span class="stat-badge" id="employeesCount">-</span>
                    </div>
                    <div class="collection-stat">
                        <span>ë¶€ì„œ (departments)</span>
                        <span class="stat-badge" id="departmentsCount">-</span>
                    </div>
                    <div class="collection-stat">
                        <span>ì‹œìŠ¤í…œ ë¡œê·¸ (logs)</span>
                        <span class="stat-badge" id="logsCount">-</span>
                    </div>
                </div>
                <div class="action-buttons" style="margin-top: var(--spacing-4);">
                    <button class="btn btn-primary" onclick="updateCollectionStats()">
                        <i class="fas fa-calculator"></i> í†µê³„ ì—…ë°ì´íŠ¸
                    </button>
                </div>
            </div>
            
            <!-- ì‹œìŠ¤í…œ ë¡œê·¸ -->
            <div class="admin-card">
                <h3><i class="fas fa-list-alt"></i> ìµœê·¼ ì‹œìŠ¤í…œ ë¡œê·¸</h3>
                <div class="status-display" id="systemLogs" style="max-height: 300px;">
                    ë¡œê·¸ ë¡œë”© ì¤‘...
                </div>
                <div class="action-buttons">
                    <button class="btn btn-primary" onclick="loadSystemLogs()">
                        <i class="fas fa-refresh"></i> ë¡œê·¸ ìƒˆë¡œê³ ì¹¨
                    </button>
                    <button class="btn btn-secondary" onclick="exportLogs()">
                        <i class="fas fa-download"></i> ë¡œê·¸ ë‚´ë³´ë‚´ê¸°
                    </button>
                </div>
            </div>
            
            <!-- í…ŒìŠ¤íŠ¸ ë°ì´í„° ê´€ë¦¬ -->
            <div class="admin-card">
                <h3><i class="fas fa-vial"></i> í…ŒìŠ¤íŠ¸ ë°ì´í„° ê´€ë¦¬</h3>
                <p style="margin-bottom: var(--spacing-4); color: var(--text-secondary);">
                    ê°œë°œ ë° í…ŒìŠ¤íŠ¸ìš© ìƒ˜í”Œ ë°ì´í„°ë¥¼ ê´€ë¦¬í•©ë‹ˆë‹¤.
                </p>
                <div class="action-buttons">
                    <button class="btn btn-success" onclick="createTestData()">
                        <i class="fas fa-plus"></i> í…ŒìŠ¤íŠ¸ ë°ì´í„° ìƒì„±
                    </button>
                    <button class="btn btn-info" onclick="validateTestData()">
                        <i class="fas fa-check"></i> ë°ì´í„° ê²€ì¦
                    </button>
                </div>
                
                <!-- ìœ„í—˜ êµ¬ì—­ -->
                <div class="danger-zone">
                    <h4><i class="fas fa-skull-crossbones"></i> ìœ„í—˜ êµ¬ì—­</h4>
                    <p style="font-size: var(--text-sm); margin-bottom: var(--spacing-3);">
                        ì•„ë˜ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì‹ ì¤‘íˆ ì‹¤í–‰í•˜ì„¸ìš”.
                    </p>
                    <button class="btn btn-danger" onclick="confirmClearTestData()">
                        <i class="fas fa-trash"></i> í…ŒìŠ¤íŠ¸ ë°ì´í„° ì‚­ì œ
                    </button>
                </div>
            </div>
            
            <!-- ë°±ì—… ë° ë³µì› -->
            <div class="admin-card">
                <h3><i class="fas fa-archive"></i> ë°±ì—… ë° ë³µì›</h3>
                <p style="margin-bottom: var(--spacing-4); color: var(--text-secondary);">
                    ë°ì´í„°ë² ì´ìŠ¤ ë°±ì—… ë° ë³µì› ê¸°ëŠ¥ (ê°œë°œ ì˜ˆì •)
                </p>
                <div class="action-buttons">
                    <button class="btn btn-secondary" disabled>
                        <i class="fas fa-save"></i> ë°±ì—… ìƒì„±
                    </button>
                    <button class="btn btn-secondary" disabled>
                        <i class="fas fa-upload"></i> ë°±ì—… ë³µì›
                    </button>
                </div>
                <div style="margin-top: var(--spacing-3); font-size: var(--text-sm); color: var(--text-muted);">
                    ğŸ’¡ í˜„ì¬ Firebase Consoleì—ì„œ ìˆ˜ë™ ë°±ì—…ì„ ê¶Œì¥í•©ë‹ˆë‹¤.
                </div>
            </div>
        </div>
    </div>
    
    <!-- Firebase v9+ modular SDK -->
    <script type="module">
        // ===========================================
        // Firebase ì„¤ì • ë° ì´ˆê¸°í™” (v9+ modular ë°©ì‹)
        // ===========================================
        
        // Firebase SDK imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-app.js";
        import { 
            getFirestore, 
            collection, 
            doc, 
            getDoc, 
            getDocs, 
            addDoc, 
            setDoc, 
            updateDoc, 
            deleteDoc, 
            query, 
            where, 
            orderBy, 
            limit, 
            serverTimestamp 
        } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-firestore.js";
        import { getAuth } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-auth.js";
        
        // Firebase ì„¤ì •
        const firebaseConfig = {
            apiKey: "AIzaSyAfSlSi4pNlKvMU-NBpQ3ZWSeG4QNpZiCk",
            authDomain: "kdv-sys.firebaseapp.com",
            projectId: "kdv-sys",
            storageBucket: "kdv-sys.firebasestorage.app",
            messagingSenderId: "352925761129",
            appId: "1:352925761129:web:a9c9cf2e1154d745faecf8"
        };
        
        // Firebase ì´ˆê¸°í™”
        let app, db, auth;
        
        try {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            console.log('ğŸ”¥ Firebase ì´ˆê¸°í™” ì„±ê³µ!');
        } catch (error) {
            console.error('âŒ Firebase ì´ˆê¸°í™” ì‹¤íŒ¨:', error);
            alert('Firebase ì—°ê²° ì‹¤íŒ¨! í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨ì„ ì‹œë„í•´ì£¼ì„¸ìš”.');
        }
        
        // ===========================================
        // ë°ì´í„°ë² ì´ìŠ¤ ì´ˆê¸°í™” í´ë˜ìŠ¤ (v9+ ë°©ì‹)
        // ===========================================
        
        class DatabaseInitializer {
            constructor() {
                this.db = db;
                this.collections = {
                    users: 'users',
                    employees: 'employees', 
                    employeePrivate: 'employee_private',
                    systemLogs: 'system_logs',
                    departments: 'departments'
                };
                
                console.log('ğŸ”§ DatabaseInitializer ì´ˆê¸°í™” ì™„ë£Œ');
            }
            
            // ì „ì²´ ë°ì´í„°ë² ì´ìŠ¤ ì´ˆê¸°í™” ì‹¤í–‰
            async initializeDatabase() {
                try {
                    console.log('ğŸš€ ë°ì´í„°ë² ì´ìŠ¤ ì´ˆê¸°í™” ì‹œì‘...');
                    
                    // 1. ë¶€ì„œ ë°ì´í„° ìƒì„±
                    await this.createDepartments();
                    
                    // 2. ì‚¬ìš©ì ë°ì´í„° ìƒì„±  
                    await this.createUsers();
                    
                    // 3. ì§ì› ë°ì´í„° ìƒì„±
                    await this.createEmployees();
                    
                    // 4. ì‹œìŠ¤í…œ ë¡œê·¸ ì´ˆê¸° ì„¤ì •
                    await this.createInitialSystemLog();
                    
                    console.log('âœ… ë°ì´í„°ë² ì´ìŠ¤ ì´ˆê¸°í™” ì™„ë£Œ!');
                    return { success: true, message: 'ë°ì´í„°ë² ì´ìŠ¤ê°€ ì„±ê³µì ìœ¼ë¡œ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.' };
                    
                } catch (error) {
                    console.error('âŒ ë°ì´í„°ë² ì´ìŠ¤ ì´ˆê¸°í™” ì‹¤íŒ¨:', error);
                    return { success: false, error: error.message };
                }
            }
            
            // ë¶€ì„œ ë°ì´í„° ìƒì„± (v9+ ë°©ì‹)
            async createDepartments() {
                console.log('ğŸ“ ë¶€ì„œ ë°ì´í„° ìƒì„± ì¤‘...');
                
                const departments = [
                    {
                        name: 'ì„ì›',
                        code: 'EXEC',
                        parentDepartment: null,
                        manager: null,
                        isActive: true,
                        description: 'ê²½ì˜ì§„ ë° ì„ì›',
                        createdAt: serverTimestamp(),
                        updatedAt: serverTimestamp()
                    },
                    {
                        name: 'ê°œë°œíŒ€',
                        code: 'DEV',
                        parentDepartment: null,
                        manager: null,
                        isActive: true,
                        description: 'ì†Œí”„íŠ¸ì›¨ì–´ ê°œë°œ ë° ê¸°ìˆ  ì§€ì›',
                        createdAt: serverTimestamp(),
                        updatedAt: serverTimestamp()
                    },
                    {
                        name: 'ì˜ì—…íŒ€',  
                        code: 'SALES',
                        parentDepartment: null,
                        manager: null,
                        isActive: true,
                        description: 'ì˜ì—… ë° ë§ˆì¼€íŒ…',
                        createdAt: serverTimestamp(),
                        updatedAt: serverTimestamp()
                    },
                    {
                        name: 'ê´€ë¦¬íŒ€',
                        code: 'ADMIN',
                        parentDepartment: null,
                        manager: null,
                        isActive: true,
                        description: 'ì¸ì‚¬, ì´ë¬´, íšŒê³„ ì—…ë¬´',
                        createdAt: serverTimestamp(),
                        updatedAt: serverTimestamp()
                    }
                ];
                
                for (const dept of departments) {
                    const deptRef = doc(db, this.collections.departments, dept.code);
                    await setDoc(deptRef, dept);
                    console.log(`âœ… ë¶€ì„œ ìƒì„± ì™„ë£Œ: ${dept.name} (${dept.code})`);
                }
            }
            
            // ì‚¬ìš©ì ë°ì´í„° ìƒì„± (v9+ ë°©ì‹)
            async createUsers() {
                console.log('ğŸ‘¤ ì‚¬ìš©ì ë°ì´í„° ìƒì„± ì¤‘...');
                
                const users = [
                    {
                        uid: 'initial-admin-uid',
                        email: 'man4korea@gmail.com',
                        displayName: 'ì´ì¸ê·œ',
                        securityLevel: '1ê¸‰',
                        isAdmin: true,
                        isActive: true,
                        department: 'ì„ì›',
                        position: 'ì´ê´„ì´ì‚¬',
                        lastLoginAt: null,
                        loginCount: 0,
                        createdAt: serverTimestamp(),
                        updatedAt: serverTimestamp()
                    },
                    {
                        uid: 'test-user-uid',
                        email: 'test@kdv.co.kr',
                        displayName: 'í…ŒìŠ¤íŠ¸ ì‚¬ìš©ì',
                        securityLevel: 'ì¼ë°˜',  
                        isAdmin: false,
                        isActive: true,
                        department: 'ê°œë°œíŒ€',
                        position: 'ê°œë°œì',
                        lastLoginAt: null,
                        loginCount: 0,
                        createdAt: serverTimestamp(),
                        updatedAt: serverTimestamp()
                    }
                ];
                
                for (const user of users) {
                    const userRef = doc(db, this.collections.users, user.uid);
                    await setDoc(userRef, user);
                    console.log(`âœ… ì‚¬ìš©ì ìƒì„± ì™„ë£Œ: ${user.displayName} (${user.email})`);
                }
            }
            
            // ì§ì› ë°ì´í„° ìƒì„± (v9+ ë°©ì‹)
            async createEmployees() {
                console.log('ğŸ‘¥ ì§ì› ë°ì´í„° ìƒì„± ì¤‘...');
                
                const employees = [
                    {
                        name: 'ì´ì¸ê·œ',
                        department: 'ì„ì›',
                        position: 'ì´ê´„ì´ì‚¬',
                        status: 'ì¬ì§',
                        joinDate: new Date('2025-05-22'),
                        quitDate: null,
                        mobile: '010-2604-5679',
                        officialEmail: 'man4korea@gmail.com',
                        employeeNumber: 'EMP001',
                        avatar: null,
                        notes: 'KDV ì‹œìŠ¤í…œ ì´ê´„ ë‹´ë‹¹',
                        createdAt: serverTimestamp(),
                        updatedAt: serverTimestamp(),
                        createdBy: 'system-init'
                    },
                    {
                        name: 'ê¹€ê°œë°œ',
                        department: 'ê°œë°œíŒ€',
                        position: 'ì„ ì„ ê°œë°œì',
                        status: 'ì¬ì§',
                        joinDate: new Date('2022-03-15'),
                        quitDate: null,
                        mobile: '010-1234-5678',
                        officialEmail: 'dev@kdv.co.kr',
                        employeeNumber: 'EMP002',
                        avatar: null,
                        notes: 'ì›¹ ê°œë°œ ì „ë‹´',
                        createdAt: serverTimestamp(),
                        updatedAt: serverTimestamp(),
                        createdBy: 'system-init'
                    },
                    {
                        name: 'ë°•ì˜ì—…',
                        department: 'ì˜ì—…íŒ€',
                        position: 'ì˜ì—… ëŒ€ë¦¬',
                        status: 'ì¬ì§',
                        joinDate: new Date('2023-01-10'),
                        quitDate: null,
                        mobile: '010-2345-6789',
                        officialEmail: 'sales@kdv.co.kr',
                        employeeNumber: 'EMP003',
                        avatar: null,
                        notes: 'ì‹ ê·œ ê³ ê° ê°œë°œ ì „ë‹´',
                        createdAt: serverTimestamp(),
                        updatedAt: serverTimestamp(),
                        createdBy: 'system-init'
                    },
                    {
                        name: 'ìµœê´€ë¦¬',
                        department: 'ê´€ë¦¬íŒ€',
                        position: 'ì£¼ì„',
                        status: 'ì¬ì§',
                        joinDate: new Date('2021-07-01'),
                        quitDate: null,
                        mobile: '010-3456-7890',
                        officialEmail: 'admin@kdv.co.kr',
                        employeeNumber: 'EMP004',
                        avatar: null,
                        notes: 'ì¸ì‚¬ ë° ì´ë¬´ ì—…ë¬´',
                        createdAt: serverTimestamp(),
                        updatedAt: serverTimestamp(),
                        createdBy: 'system-init'
                    }
                ];
                
                const employeeIds = [];
                
                for (const employee of employees) {
                    const empRef = await addDoc(collection(db, this.collections.employees), employee);
                    employeeIds.push({ id: empRef.id, name: employee.name, department: employee.department, officialEmail: employee.officialEmail });
                    console.log(`âœ… ì§ì› ìƒì„± ì™„ë£Œ: ${employee.name} (${employee.position})`);
                }
                
                // ë¯¼ê°í•œ ê°œì¸ì •ë³´ëŠ” ë³„ë„ ì»¬ë ‰ì…˜ì— ì €ì¥
                await this.createEmployeePrivateData(employeeIds);
                
                return employeeIds;
            }
            
            // ì§ì› ë¯¼ê°ì •ë³´ ìƒì„± (ì•”í˜¸í™”)
            async createEmployeePrivateData(employeeIds) {
                console.log('ğŸ”’ ì§ì› ë¯¼ê°ì •ë³´ ìƒì„± ì¤‘...');
                
                const inkgyuEmployee = employeeIds.find(emp => emp.officialEmail === 'man4korea@gmail.com');
                
                const privateData = [];
                
                if (inkgyuEmployee) {
                    privateData.push({
                        employeeId: inkgyuEmployee.id, 
                        personalEmail: this.encryptData('man4korea@hotmail.com'),
                        residentRegistrationNumber: this.encryptData('600915-1566812'),
                        homeAddress: this.encryptData('ê²½ê¸°ë„ ì˜ì •ë¶€ì‹œ íšŒë£¡ë¡œ 254 ì¥ì•”ì£¼ê³µ7ë‹¨ì§€ 707ë™ 202í˜¸'),
                        emergencyContact: {
                            name: this.encryptData('ë¹„ê³µê°œ'),
                            relationship: 'ê°€ì¡±',
                            phone: this.encryptData('010-9507-2421')
                        },
                        birthDate: this.encryptData('1960-09-15'),
                        bankAccount: {
                            bank: this.encryptData('êµ­ë¯¼ì€í–‰'),
                            accountNumber: this.encryptData('123456-78-901234'),
                            accountHolder: this.encryptData('ì´ì¸ê·œ')
                        },
                        salary: {
                            baseSalary: this.encryptData('5000000'),
                            allowances: this.encryptData('500000'),
                            lastUpdated: serverTimestamp()
                        },
                        createdAt: serverTimestamp(),
                        updatedAt: serverTimestamp()
                    });
                }
                
                for (const data of privateData) {
                    const privateRef = doc(db, this.collections.employeePrivate, data.employeeId);
                    await setDoc(privateRef, data);
                    console.log(`ğŸ”’ ë¯¼ê°ì •ë³´ ìƒì„± ì™„ë£Œ: ${data.employeeId}`);
                }
            }
            
            // ì´ˆê¸° ì‹œìŠ¤í…œ ë¡œê·¸ ìƒì„± (v9+ ë°©ì‹)
            async createInitialSystemLog() {
                console.log('ğŸ“‹ ì´ˆê¸° ì‹œìŠ¤í…œ ë¡œê·¸ ìƒì„± ì¤‘...');
                
                const initialLog = {
                    action: 'SYSTEM_INIT',
                    userId: 'admin-user-001',
                    targetCollection: 'system',
                    targetDocumentId: 'database-init',
                    details: {
                        message: 'ë°ì´í„°ë² ì´ìŠ¤ ì´ˆê¸°í™” ì™„ë£Œ',
                        collections: Object.keys(this.collections),
                        timestamp: new Date().toISOString()
                    },
                    timestamp: serverTimestamp(),
                    ipAddress: 'localhost',
                    userAgent: navigator.userAgent
                };
                
                await addDoc(collection(db, this.collections.systemLogs), initialLog);
                console.log('âœ… ì´ˆê¸° ì‹œìŠ¤í…œ ë¡œê·¸ ìƒì„± ì™„ë£Œ');
            }
            
            // ê°„ë‹¨í•œ ë°ì´í„° ì•”í˜¸í™” í•¨ìˆ˜
            encryptData(data) {
                if (!data) return null;
                
                try {
                    return btoa(unescape(encodeURIComponent(data + '_encrypted_' + Date.now())));
                } catch (error) {
                    console.error('ì•”í˜¸í™” ì‹¤íŒ¨:', error);
                    return data;
                }
            }
            
            // ë°ì´í„°ë² ì´ìŠ¤ ìƒíƒœ í™•ì¸ (v9+ ë°©ì‹)
            async checkDatabaseStatus() {
                console.log('ğŸ” ë°ì´í„°ë² ì´ìŠ¤ ìƒíƒœ í™•ì¸ ì¤‘...');
                
                const status = {
                    collections: {},
                    totalDocuments: 0,
                    timestamp: new Date().toISOString()
                };
                
                for (const [key, collectionName] of Object.entries(this.collections)) {
                    try {
                        const querySnapshot = await getDocs(collection(db, collectionName));
                        status.collections[key] = {
                            name: collectionName,
                            documentCount: querySnapshot.size,
                            exists: !querySnapshot.empty
                        };
                        status.totalDocuments += querySnapshot.size;
                    } catch (error) {
                        console.error(`ì»¬ë ‰ì…˜ ìƒíƒœ í™•ì¸ ì‹¤íŒ¨ (${collectionName}):`, error);
                        status.collections[key] = {
                            name: collectionName,
                            documentCount: 0,
                            exists: false,
                            error: error.message
                        };
                    }
                }
                
                console.log('ğŸ“Š ë°ì´í„°ë² ì´ìŠ¤ ìƒíƒœ:', status);
                return status;
            }
        }
        
        // ===========================================
        // ì „ì—­ ë³€ìˆ˜ ë° í•¨ìˆ˜ë“¤
        // ===========================================
        
        const dbInitializer = new DatabaseInitializer();
        
        // ë¡œë”© ì˜¤ë²„ë ˆì´ í•¨ìˆ˜ë“¤
        window.showLoading = function(message) {
            const overlay = document.getElementById('loadingOverlay');
            const msgEl = document.getElementById('loadingMessage');
            if (overlay) overlay.style.display = 'flex';
            if (msgEl) msgEl.textContent = message || 'ì²˜ë¦¬ ì¤‘...';
        }
        
        window.hideLoading = function() {
            const overlay = document.getElementById('loadingOverlay');
            if (overlay) overlay.style.display = 'none';
        }
        
        // ===========================================
        // í˜ì´ì§€ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ë“¤ (v9+ ë°©ì‹)
        // ===========================================
        
        // ë°ì´í„°ë² ì´ìŠ¤ ì´ˆê¸°í™”
        window.initializeDatabase = async function() {
            showLoading('ë°ì´í„°ë² ì´ìŠ¤ ì´ˆê¸°í™” ì¤‘...');
            const statusDisplay = document.getElementById('initStatus');
            const progressBar = document.getElementById('initProgress');
            const progressFill = document.getElementById('initProgressFill');
            
            statusDisplay.style.display = 'block';
            progressBar.style.display = 'block';
            statusDisplay.textContent = 'ì´ˆê¸°í™” ì‹œì‘...';
            progressFill.style.width = '10%';
            
            try {
                progressFill.style.width = '30%';
                statusDisplay.textContent = 'ë¶€ì„œ ë°ì´í„° ìƒì„± ì¤‘...';
                
                const result = await dbInitializer.initializeDatabase();
                
                progressFill.style.width = '100%';
                
                if (result.success) {
                    statusDisplay.textContent = 'âœ… ' + result.message;
                    statusDisplay.style.color = 'var(--success)';
                } else {
                    statusDisplay.textContent = 'âŒ ' + result.error;
                    statusDisplay.style.color = 'var(--danger)';
                }
            } catch (error) {
                progressFill.style.width = '100%';
                statusDisplay.textContent = 'âŒ ì´ˆê¸°í™” ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ' + error.message;
                statusDisplay.style.color = 'var(--danger)';
                console.error('ì´ˆê¸°í™” ì˜¤ë¥˜:', error);
            } finally {
                hideLoading();
                setTimeout(() => updateCollectionStats(), 1000);
            }
        }
        
        // ë°ì´í„°ë² ì´ìŠ¤ ìƒíƒœ í™•ì¸
        window.checkDatabaseStatus = async function() {
            showLoading('ë°ì´í„°ë² ì´ìŠ¤ ìƒíƒœ í™•ì¸ ì¤‘...');
            const statusDisplay = document.getElementById('dbStatus');
            
            try {
                const usersSnapshot = await getDocs(collection(db, 'users'));
                const employeesSnapshot = await getDocs(collection(db, 'employees'));
                const departmentsSnapshot = await getDocs(collection(db, 'departments'));
                const logsSnapshot = await getDocs(collection(db, 'system_logs'));
                
                statusDisplay.textContent = `âœ… Firestore ì—°ê²° ìƒíƒœ ì–‘í˜¸
ì‚¬ìš©ì: ${usersSnapshot.size}ê±´
ì§ì›: ${employeesSnapshot.size}ê±´
ë¶€ì„œ: ${departmentsSnapshot.size}ê±´
ë¡œê·¸: ${logsSnapshot.size}ê±´`;
                statusDisplay.style.color = 'var(--success)';
            } catch (error) {
                statusDisplay.textContent = 'âŒ Firestore ì—°ê²° ì‹¤íŒ¨: ' + error.message;
                statusDisplay.style.color = 'var(--danger)';
                console.error('ë°ì´í„°ë² ì´ìŠ¤ ìƒíƒœ í™•ì¸ ì‹¤íŒ¨:', error);
            } finally {
                hideLoading();
            }
        }
        
        // ì»¬ë ‰ì…˜ í†µê³„ ì—…ë°ì´íŠ¸
        window.updateCollectionStats = async function() {
            showLoading('ì»¬ë ‰ì…˜ í†µê³„ ì—…ë°ì´íŠ¸ ì¤‘...');
            
            try {
                const stats = await dbInitializer.checkDatabaseStatus();
                
                document.getElementById('usersCount').textContent = stats.collections.users.documentCount;
                document.getElementById('employeesCount').textContent = stats.collections.employees.documentCount;
                document.getElementById('departmentsCount').textContent = stats.collections.departments.documentCount;
                document.getElementById('logsCount').textContent = stats.collections.systemLogs.documentCount;
            } catch (error) {
                console.error('ì»¬ë ‰ì…˜ í†µê³„ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨:', error);
                alert('ì»¬ë ‰ì…˜ í†µê³„ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨: ' + error.message);
            } finally {
                hideLoading();
            }
        }
        
        // ì—°ê²° í…ŒìŠ¤íŠ¸
        window.testConnection = async function() {
            showLoading('ì—°ê²° í…ŒìŠ¤íŠ¸ ì¤‘...');
            
            try {
                // ê°„ë‹¨í•œ ì½ê¸° í…ŒìŠ¤íŠ¸
                const testQuery = query(collection(db, 'departments'), limit(1));
                await getDocs(testQuery);
                alert('âœ… Firebase ì—°ê²° í…ŒìŠ¤íŠ¸ ì„±ê³µ!');
            } catch (error) {
                alert('âŒ Firebase ì—°ê²° í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨: ' + error.message);
                console.error('ì—°ê²° í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨:', error);
            } finally {
                hideLoading();
            }
        }
        
        // ì´ˆê¸°í™” ë¯¸ë¦¬ë³´ê¸°
        window.showInitPreview = function() {
            const previewText = `
ë°ì´í„°ë² ì´ìŠ¤ ì´ˆê¸°í™” ì˜ˆì • ì‘ì—…:

ğŸ“ ë¶€ì„œ (departments):
- ì„ì› (EXEC)
- ê°œë°œíŒ€ (DEV)
- ì˜ì—…íŒ€ (SALES)
- ê´€ë¦¬íŒ€ (ADMIN)

ğŸ‘¤ ì‚¬ìš©ì (users):
- ì´ì¸ê·œ (man4korea@gmail.com) - 1ê¸‰ ê´€ë¦¬ì
- í…ŒìŠ¤íŠ¸ ì‚¬ìš©ì (test@kdv.co.kr) - ì¼ë°˜ ì‚¬ìš©ì

ğŸ‘¥ ì§ì› (employees):
- ì´ì¸ê·œ (ì´ê´„ì´ì‚¬)
- ê¹€ê°œë°œ (ì„ ì„ ê°œë°œì)
- ë°•ì˜ì—… (ì˜ì—… ëŒ€ë¦¬)
- ìµœê´€ë¦¬ (ì£¼ì„)

ğŸ”’ ë¯¼ê°ì •ë³´ (employee_private):
- ì´ì¸ê·œ ê°œì¸ì •ë³´ (ì•”í˜¸í™” ì €ì¥)

ğŸ“‹ ì‹œìŠ¤í…œ ë¡œê·¸ (system_logs):
- ì´ˆê¸°í™” ë¡œê·¸ ìƒì„±
            `;
            
            alert(previewText);
        }
        
        // í…ŒìŠ¤íŠ¸ ë°ì´í„° ìƒì„±
        window.createTestData = async function() {
            showLoading('í…ŒìŠ¤íŠ¸ ë°ì´í„° ìƒì„± ì¤‘...');
            
            try {
                // ì¶”ê°€ í…ŒìŠ¤íŠ¸ ì§ì› ìƒì„±
                const testEmployees = [
                    {
                        name: 'í™í…ŒìŠ¤íŠ¸',
                        department: 'ê°œë°œíŒ€',
                        position: 'ì¸í„´',
                        status: 'ì¬ì§',
                        joinDate: new Date(),
                        mobile: '010-9999-0001',
                        officialEmail: 'test1@kdv.co.kr',
                        employeeNumber: 'TEST001',
                        notes: 'í…ŒìŠ¤íŠ¸ìš© ì§ì› ë°ì´í„°',
                        createdAt: serverTimestamp(),
                        updatedAt: serverTimestamp(),
                        createdBy: 'admin-test'
                    },
                    {
                        name: 'ê¹€ìƒ˜í”Œ',
                        department: 'ì˜ì—…íŒ€',
                        position: 'ì¸í„´',
                        status: 'ì¬ì§',
                        joinDate: new Date(),
                        mobile: '010-9999-0002',
                        officialEmail: 'test2@kdv.co.kr',
                        employeeNumber: 'TEST002',
                        notes: 'í…ŒìŠ¤íŠ¸ìš© ì§ì› ë°ì´í„°',
                        createdAt: serverTimestamp(),
                        updatedAt: serverTimestamp(),
                        createdBy: 'admin-test'
                    }
                ];
                
                for (const employee of testEmployees) {
                    await addDoc(collection(db, 'employees'), employee);
                    console.log(`âœ… í…ŒìŠ¤íŠ¸ ì§ì› ìƒì„±: ${employee.name}`);
                }
                
                alert('âœ… í…ŒìŠ¤íŠ¸ ë°ì´í„° ìƒì„± ì™„ë£Œ!');
                updateCollectionStats();
                
            } catch (error) {
                alert('âŒ í…ŒìŠ¤íŠ¸ ë°ì´í„° ìƒì„± ì‹¤íŒ¨: ' + error.message);
                console.error('í…ŒìŠ¤íŠ¸ ë°ì´í„° ìƒì„± ì‹¤íŒ¨:', error);
            } finally {
                hideLoading();
            }
        }
        
        // ë°ì´í„° ê²€ì¦
        window.validateTestData = async function() {
            showLoading('ë°ì´í„° ê²€ì¦ ì¤‘...');
            
            try {
                const validationResults = [];
                
                // ë¶€ì„œ ë°ì´í„° ê²€ì¦
                const deptSnapshot = await getDocs(collection(db, 'departments'));
                validationResults.push(`ë¶€ì„œ: ${deptSnapshot.size}ê°œ - ${deptSnapshot.empty ? 'âŒ' : 'âœ…'}`);
                
                // ì§ì› ë°ì´í„° ê²€ì¦
                const empSnapshot = await getDocs(collection(db, 'employees'));
                validationResults.push(`ì§ì›: ${empSnapshot.size}ê°œ - ${empSnapshot.empty ? 'âŒ' : 'âœ…'}`);
                
                // ì‚¬ìš©ì ë°ì´í„° ê²€ì¦
                const userSnapshot = await getDocs(collection(db, 'users'));
                validationResults.push(`ì‚¬ìš©ì: ${userSnapshot.size}ê°œ - ${userSnapshot.empty ? 'âŒ' : 'âœ…'}`);
                
                // ë¡œê·¸ ë°ì´í„° ê²€ì¦
                const logSnapshot = await getDocs(collection(db, 'system_logs'));
                validationResults.push(`ì‹œìŠ¤í…œ ë¡œê·¸: ${logSnapshot.size}ê°œ - ${logSnapshot.empty ? 'âŒ' : 'âœ…'}`);
                
                alert('ğŸ“‹ ë°ì´í„° ê²€ì¦ ê²°ê³¼:\n\n' + validationResults.join('\n'));
                
            } catch (error) {
                alert('âŒ ë°ì´í„° ê²€ì¦ ì‹¤íŒ¨: ' + error.message);
                console.error('ë°ì´í„° ê²€ì¦ ì‹¤íŒ¨:', error);
            } finally {
                hideLoading();
            }
        }
        
        // í…ŒìŠ¤íŠ¸ ë°ì´í„° ì‚­ì œ í™•ì¸
        window.confirmClearTestData = function() {
            if (confirm('âš ï¸ ì£¼ì˜: ëª¨ë“  í…ŒìŠ¤íŠ¸ ë°ì´í„°ê°€ ì‚­ì œë©ë‹ˆë‹¤.\n\nì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\n\nì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                if (confirm('ì •ë§ë¡œ í™•ì‹¤í•©ë‹ˆê¹Œ? ëª¨ë“  ì»¬ë ‰ì…˜ì˜ ë°ì´í„°ê°€ ì‚­ì œë©ë‹ˆë‹¤!')) {
                    clearTestData();
                }
            }
        }
        
        // í…ŒìŠ¤íŠ¸ ë°ì´í„° ì‚­ì œ
        window.clearTestData = async function() {
            showLoading('í…ŒìŠ¤íŠ¸ ë°ì´í„° ì‚­ì œ ì¤‘...');
            
            try {
                // Firebaseì—ì„œëŠ” í´ë¼ì´ì–¸íŠ¸ì—ì„œ ëŒ€ëŸ‰ ì‚­ì œê°€ ì œí•œë˜ë¯€ë¡œ
                // ì‹¤ì œë¡œëŠ” Firebase Consoleì´ë‚˜ ì„œë²„ ì‚¬ì´ë“œì—ì„œ ì‚­ì œí•´ì•¼ í•¨
                alert('âš ï¸ ì‹¤ì œ ë°ì´í„° ì‚­ì œëŠ” Firebase Consoleì—ì„œ ìˆ˜í–‰í•´ì£¼ì„¸ìš”.\n\në³´ì•ˆìƒ í´ë¼ì´ì–¸íŠ¸ì—ì„œëŠ” ëŒ€ëŸ‰ ì‚­ì œê°€ ì œí•œë©ë‹ˆë‹¤.');
                
            } catch (error) {
                alert('âŒ í…ŒìŠ¤íŠ¸ ë°ì´í„° ì‚­ì œ ì‹¤íŒ¨: ' + error.message);
                console.error('í…ŒìŠ¤íŠ¸ ë°ì´í„° ì‚­ì œ ì‹¤íŒ¨:', error);
            } finally {
                hideLoading();
            }
        }
        
        // ì‹œìŠ¤í…œ ë¡œê·¸ ë¡œë“œ
        window.loadSystemLogs = async function() {
            showLoading('ì‹œìŠ¤í…œ ë¡œê·¸ ë¡œë”© ì¤‘...');
            const logsDisplay = document.getElementById('systemLogs');
            
            try {
                const logsQuery = query(
                    collection(db, 'system_logs'), 
                    orderBy('timestamp', 'desc'), 
                    limit(10)
                );
                const logsSnapshot = await getDocs(logsQuery);
                
                if (logsSnapshot.empty) {
                    logsDisplay.textContent = 'ì‹œìŠ¤í…œ ë¡œê·¸ê°€ ì—†ìŠµë‹ˆë‹¤.';
                    return;
                }
                
                let logsText = '';
                logsSnapshot.forEach(doc => {
                    const data = doc.data();
                    const timestamp = data.timestamp ? data.timestamp.toDate().toLocaleString() : 'ì‹œê°„ ì •ë³´ ì—†ìŒ';
                    logsText += `[${timestamp}] ${data.action} - ${data.details?.message || 'ì„¸ë¶€ ì •ë³´ ì—†ìŒ'}\n`;
                });
                
                logsDisplay.textContent = logsText || 'ë¡œê·¸ ë°ì´í„°ë¥¼ ì½ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.';
                
            } catch (error) {
                logsDisplay.textContent = 'âŒ ì‹œìŠ¤í…œ ë¡œê·¸ ë¡œë”© ì‹¤íŒ¨: ' + error.message;
                console.error('ì‹œìŠ¤í…œ ë¡œê·¸ ë¡œë”© ì‹¤íŒ¨:', error);
            } finally {
                hideLoading();
            }
        }
        
        // ë¡œê·¸ ë‚´ë³´ë‚´ê¸°
        window.exportLogs = async function() {
            showLoading('ë¡œê·¸ ë‚´ë³´ë‚´ê¸° ì¤‘...');
            
            try {
                const logsQuery = query(collection(db, 'system_logs'), orderBy('timestamp', 'desc'));
                const logsSnapshot = await getDocs(logsQuery);
                
                if (logsSnapshot.empty) {
                    alert('ë‚´ë³´ë‚¼ ë¡œê·¸ê°€ ì—†ìŠµë‹ˆë‹¤.');
                    return;
                }
                
                let csvContent = 'Timestamp,Action,User ID,Target Collection,Details\n';
                
                logsSnapshot.forEach(doc => {
                    const data = doc.data();
                    const timestamp = data.timestamp ? data.timestamp.toDate().toISOString() : '';
                    const details = data.details ? JSON.stringify(data.details).replace(/"/g, '""') : '';
                    
                    csvContent += `"${timestamp}","${data.action}","${data.userId}","${data.targetCollection || ''}","${details}"\n`;
                });
                
                // CSV íŒŒì¼ ë‹¤ìš´ë¡œë“œ
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', `system_logs_${new Date().toISOString().split('T')[0]}.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                alert('âœ… ë¡œê·¸ íŒŒì¼ì´ ë‹¤ìš´ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.');
                
            } catch (error) {
                alert('âŒ ë¡œê·¸ ë‚´ë³´ë‚´ê¸° ì‹¤íŒ¨: ' + error.message);
                console.error('ë¡œê·¸ ë‚´ë³´ë‚´ê¸° ì‹¤íŒ¨:', error);
            } finally {
                hideLoading();
            }
        }
        
        // ===========================================
        // í˜ì´ì§€ ë¡œë“œ ì™„ë£Œ ì‹œ ì´ˆê¸°í™”
        // ===========================================
        
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ğŸ“Š DB ê´€ë¦¬ì í˜ì´ì§€ ë¡œë“œ ì™„ë£Œ');
            
            // ì´ˆê¸° ìƒíƒœ í™•ì¸
            setTimeout(() => {
                checkDatabaseStatus();
                updateCollectionStats();
            }, 1000);
        });
    </script>
</body>
</html>